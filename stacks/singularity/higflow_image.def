Bootstrap: docker
From: ubuntu:22.04

%setup
    mkdir -p ${SINGULARITY_ROOTFS}/bibliotecas
    mkdir -p ${SINGULARITY_ROOTFS}/scripts

%post
    #############################################################
    #                       BASE                                #
    #############################################################
    export TZ="America/Sao_Paulo"
    ln -snf /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime 
    echo "America/Sao_Paulo" > /etc/timezone
    apt-get -y update
    apt-get install -y apt-utils
    apt-get install -y software-properties-common 
    add-apt-repository universe
    apt-get update

    apt install -y libglib2.0-dev libboost-all-dev valgrind cmake gfortran libhypre-dev \
                    libhdf5-openmpi-dev openmpi-bin mpi libopenmpi-dev libtrilinos-zoltan-dev \
                    mpich gcc autoconf automake libtool git make libltdl-dev pkg-config \
                    libyaml-dev check python3 python3-pip python3-setuptools libyaml-dev unzip

    #############################################################
    #                    THIRD-PART LIBS                        #
    #############################################################

    ## Pip
    ./scripts/pip.sh > /scripts/pip_build.log 2>&1 

    ## Libfyaml
    ./scripts/libfyaml.sh > /scripts/libfyaml_build.log 2>&1

    ## Petsc
    ./scripts/petsc.sh > /scripts/petsc_build.log 2>&1

    ## hypre
    ./scripts/hypre.sh > /scripts/hypre_build.log 2>&1

%environment

    export LIBFYAML_INSTALL_DIR="/opt/libfyaml"
    export LIBFYAML_DIR="${LIBFYAML_INSTALL_DIR}"
    export LIBFYAML_LIB="${LIBFYAML_INSTALL_DIR}/lib"
    export LIBFYAML_INC="${LIBFYAML_INSTALL_DIR}/include"

    export LIBRARY_PATH="${LIBFYAML_LIB}:${LIBRARY_PATH}"
    export LD_LIBRARY_PATH="${LIBFYAML_LIB}:${LD_LIBRARY_PATH}"
        
    export INCLUDE="${LIBFYAML_INC}:${INCLUDE}"
    export CPLUS_INCLUDE_PATH="${LIBFYAML_INC}:${CPLUS_INCLUDE_PATH}"
    export CPATH="${LIBFYAML_INC}:${CPATH}"
    export C_INCLUDE_PATH="${LIBFYAML_INC}:${C_INCLUDE_PATH}"

    export PKG_CONFIG_PATH="${LIBFYAML_LIB}/pkgconfig:${PKG_CONFIG_PATH}"

    export PETSC_INSTALL_DIR="/opt/petsc-3.14.0-openmnpi-hypre-hdf5"
    export PETSC_DIR="${PETSC_INSTALL_DIR}"
    export PETSC_LIB="${PETSC_INSTALL_DIR}/lib"
    export PETSC_INC="${PETSC_INSTALL_DIR}/include"

    export LIBRARY_PATH="${PETSC_LIB}:${LIBRARY_PATH}"
    export LD_LIBRARY_PATH="${PETSC_LIB}:${LD_LIBRARY_PATH}"
        
    export INCLUDE="${PETSC_INC}:${INCLUDE}"
    export CPLUS_INCLUDE_PATH="${PETSC_INC}:${CPLUS_INCLUDE_PATH}"
    export CPATH="${PETSC_INC}:${CPATH}"
    export C_INCLUDE_PATH="${PETSC_INC}:${C_INCLUDE_PATH}"

    export PKG_CONFIG_PATH="${PETSC_LIB}/pkgconfig:${PKG_CONFIG_PATH}"